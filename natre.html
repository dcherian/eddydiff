
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NATRE region variance budget &#8212; Eddy Diffusivity</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="NATRE microstructure dataset" href="natre-examine.html" />
    <link rel="prev" title="Bootstrapped outlier detection for CTD-χpod" href="bootstrap-ctd-chipod-estimates.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Eddy Diffusivity</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Moored χpod analysis
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="tao.html">
   TAO (0, 140) χpod
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="equix.html">
   EQUIX
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  CTD χpod analysis
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="BoB-ctd-chipod.html">
   BoB ASIRI 2013 CTD χpod
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="P06.html">
   P06 CTD χpod analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sections-variance-estimate.html">
   Eddy variance generation along GO-SHIP lines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ctd-%CF%87-A05.html">
   CTD χpod A05 section
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="bootstrap-ctd-chipod-estimates.html">
   Bootstrapped outlier detection for CTD-χpod
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Variance budgets
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   NATRE region variance budget
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NATRE region analysis
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="natre-examine.html">
   NATRE microstructure dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="natre-finescale.html">
   NATRE micro vs finescale
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Finestructure analysis
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="iw-fine-argo.html">
   Argo finescale estimates
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="iw-fine-estimates.html">
   Existing finestructure estimates
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="iw-fine-devel.html">
   Finescale Mixing Parametrizations: Development
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ancillary analysis
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="compare-Ke-estimates.html">
   Compare different
   <span class="math notranslate nohighlight">
    \(K_e\)
   </span>
   estimates
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="equix-vs-tao.html">
   χpods: EQUIX vs TAO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="eqpac-ts-diagrams.html">
   T-S diagrams from TAO &amp; Argo at (0, 145W→135W)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dataset-processing.html">
   Dataset processing
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/natre.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/dcherian/eddydiff"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/dcherian/eddydiff/master?urlpath=tree/notebooks/natre.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compute-natre-microstructure-terms">
   Compute NATRE microstructure terms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prepare-various-production-and-dissipation-terms">
   Prepare various production and dissipation terms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pop-1-10-vs-pop-1">
   POP 1/10 vs POP 1
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#variance-production-vs-dissipation">
   Variance production vs dissipation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interpretation">
     Interpretation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#spicy-region">
       Spicy region
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#weak-spice">
       Weak spice
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#next-steps">
     Next steps:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#all-microscale-budget-terms">
   All microscale budget terms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pop2-1-10-mesoscale-variance-budget">
   POP2 1/10° mesoscale variance budget
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#error-bounds">
   Error bounds
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microstructure">
     Microstructure
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#studying-cole-estimate">
   Studying Cole estimate
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-cole-groeskamp-diffusivities">
     Compare Cole &amp; Groeskamp diffusivities
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#depth-vs-density-space-estimation-of-k-e-t-2">
     Depth-vs-density space estimation of
     <span class="math notranslate nohighlight">
      \(K_e |∇T|²\)
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#depth-space-calculation">
     Depth space calculation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#t-s-diagrams-argo-vs-natre">
   T-S diagrams: Argo vs. NATRE
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#all-argo-vs-natre">
     All argo vs NATRE
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#finestructure-argo-vs-natre">
     Finestructure Argo vs NATRE
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#conclusions">
     Conclusions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#is-there-spatial-uncertainty-cole-estimate-are-we-looking-in-the-wrong-place-no">
     Is there spatial uncertainty? Cole estimate: Are we looking in the wrong place? No
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sensitivity-of-pod-estimate-to-mean-k-estimate">
   Sensitivity of χpod estimate to mean K estimate
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bootstrapping-error-bars-on-mean">
   Bootstrapping error bars on mean χ
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-neutral-density-bins-to-fp2005">
     Compare neutral density bins to FP2005
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>NATRE region variance budget</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compute-natre-microstructure-terms">
   Compute NATRE microstructure terms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prepare-various-production-and-dissipation-terms">
   Prepare various production and dissipation terms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pop-1-10-vs-pop-1">
   POP 1/10 vs POP 1
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#variance-production-vs-dissipation">
   Variance production vs dissipation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interpretation">
     Interpretation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#spicy-region">
       Spicy region
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#weak-spice">
       Weak spice
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#next-steps">
     Next steps:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#all-microscale-budget-terms">
   All microscale budget terms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pop2-1-10-mesoscale-variance-budget">
   POP2 1/10° mesoscale variance budget
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#error-bounds">
   Error bounds
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#microstructure">
     Microstructure
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#studying-cole-estimate">
   Studying Cole estimate
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-cole-groeskamp-diffusivities">
     Compare Cole &amp; Groeskamp diffusivities
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#depth-vs-density-space-estimation-of-k-e-t-2">
     Depth-vs-density space estimation of
     <span class="math notranslate nohighlight">
      \(K_e |∇T|²\)
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#depth-space-calculation">
     Depth space calculation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#t-s-diagrams-argo-vs-natre">
   T-S diagrams: Argo vs. NATRE
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#all-argo-vs-natre">
     All argo vs NATRE
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#finestructure-argo-vs-natre">
     Finestructure Argo vs NATRE
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#conclusions">
     Conclusions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#is-there-spatial-uncertainty-cole-estimate-are-we-looking-in-the-wrong-place-no">
     Is there spatial uncertainty? Cole estimate: Are we looking in the wrong place? No
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sensitivity-of-pod-estimate-to-mean-k-estimate">
   Sensitivity of χpod estimate to mean K estimate
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bootstrapping-error-bars-on-mean">
   Bootstrapping error bars on mean χ
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-neutral-density-bins-to-fp2005">
     Compare neutral density bins to FP2005
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="natre-region-variance-budget">
<h1>NATRE region variance budget<a class="headerlink" href="#natre-region-variance-budget" title="Permalink to this headline">¶</a></h1>
<p>Reproducing the Ferrari &amp; Polzin (2005) estimate using NATRE data, and comparing differences with our version</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> watermark
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">glob</span>

<span class="kn">import</span> <span class="nn">cf_xarray</span> <span class="k">as</span> <span class="nn">cfxr</span>
<span class="kn">import</span> <span class="nn">dcpy</span>
<span class="kn">import</span> <span class="nn">distributed</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">xgcm</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">xarray.tests</span> <span class="kn">import</span> <span class="n">raise_if_dask_computes</span>

<span class="o">%</span><span class="k">aimport</span> eddydiff
<span class="n">ed</span> <span class="o">=</span> <span class="n">eddydiff</span>

<span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">140</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;savefig.dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;ggplot&quot;</span><span class="p">)</span>


<span class="o">%</span><span class="k">watermark</span> -iv
<span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matplotlib : 3.5.1
tqdm       : 4.62.3
scipy      : 1.7.3
dcpy       : 0.1
distributed: 2021.12.0
xgcm       : 0.6.0
xarray     : 0.20.3.dev137+g3f3a197c8
cf_xarray  : 0.6.4.dev14+g9b4d1e0.d20220121
numpy      : 1.22.0
eddydiff   : 0.1
</pre></div>
</div>
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray (dim_0: 1)&gt;
array([1.])
Dimensions without coordinates: dim_0</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'></div><ul class='xr-dim-list'><li><span>dim_0</span>: 1</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-5b05e5f4-5804-423b-888e-a7bd00eeaf80' class='xr-array-in' type='checkbox' checked><label for='section-5b05e5f4-5804-423b-888e-a7bd00eeaf80' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>1.0</span></div><div class='xr-array-data'><pre>array([1.])</pre></div></div></li><li class='xr-section-item'><input id='section-7c5fe2ff-e6f4-4607-a150-073864892f27' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-7c5fe2ff-e6f4-4607-a150-073864892f27' class='xr-section-summary'  title='Expand/collapse section'>Coordinates: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'></ul></div></li><li class='xr-section-item'><input id='section-647d11cb-34d6-4bbf-bcfe-eb256953d68a' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-647d11cb-34d6-4bbf-bcfe-eb256953d68a' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s2">&quot;client&quot;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="n">client</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">distributed</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">client</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-vx1p4w_z&#39;, purging
distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-zjpgc9hg&#39;, purging
distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-bxn_9lb1&#39;, purging
distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-z_4tl93n&#39;, purging
distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-pge_7w4c&#39;, purging
distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-0pf3zhz7&#39;, purging
distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-qqeldho7&#39;, purging
distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-21q0kw62&#39;, purging
distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-8jrjh7pt&#39;, purging
distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-7ms7ug_a&#39;, purging
distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-qm93w0j0&#39;, purging
distributed.diskutils - INFO - Found stale lock file and directory &#39;/Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-pio0yyiw&#39;, purging
</pre></div>
</div>
<div class="output text_html"><div>
    <div style="width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;"> </div>
    <div style="margin-left: 48px;">
        <h3 style="margin-bottom: 0px;">Client</h3>
        <p style="color: #9D9D9D; margin-bottom: 0px;">Client-3ec4e580-7d58-11ec-925d-acde48001122</p>
        <table style="width: 100%; text-align: left;">

        <tr>

            <td style="text-align: left;"><strong>Connection method:</strong> Cluster object</td>
            <td style="text-align: left;"><strong>Cluster type:</strong> distributed.LocalCluster</td>

        </tr>


            <tr>
                <td style="text-align: left;">
                    <strong>Dashboard: </strong> <a href="http://127.0.0.1:8787/status" target="_blank">http://127.0.0.1:8787/status</a>
                </td>
                <td style="text-align: left;"></td>
            </tr>


        </table>


            <details>
            <summary style="margin-bottom: 20px;"><h3 style="display: inline;">Cluster Info</h3></summary>
            <div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-mod-trusted jp-OutputArea-output">
    <div style="width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;">
    </div>
    <div style="margin-left: 48px;">
        <h3 style="margin-bottom: 0px; margin-top: 0px;">LocalCluster</h3>
        <p style="color: #9D9D9D; margin-bottom: 0px;">74c552cb</p>
        <table style="width: 100%; text-align: left;">
            <tr>
                <td style="text-align: left;">
                    <strong>Dashboard:</strong> <a href="http://127.0.0.1:8787/status" target="_blank">http://127.0.0.1:8787/status</a>
                </td>
                <td style="text-align: left;">
                    <strong>Workers:</strong> 6
                </td>
            </tr>
            <tr>
                <td style="text-align: left;">
                    <strong>Total threads:</strong> 6
                </td>
                <td style="text-align: left;">
                    <strong>Total memory:</strong> 16.00 GiB
                </td>
            </tr>

            <tr>
    <td style="text-align: left;"><strong>Status:</strong> running</td>
    <td style="text-align: left;"><strong>Using processes:</strong> True</td>
</tr>


        </table>

        <details>
            <summary style="margin-bottom: 20px;">
                <h3 style="display: inline;">Scheduler Info</h3>
            </summary>

            <div style="">
    <div>
        <div style="width: 24px; height: 24px; background-color: #FFF7E5; border: 3px solid #FF6132; border-radius: 5px; position: absolute;"> </div>
        <div style="margin-left: 48px;">
            <h3 style="margin-bottom: 0px;">Scheduler</h3>
            <p style="color: #9D9D9D; margin-bottom: 0px;">Scheduler-1c98ec5c-49dd-47c7-822f-4cc0d1775aaf</p>
            <table style="width: 100%; text-align: left;">
                <tr>
                    <td style="text-align: left;">
                        <strong>Comm:</strong> tcp://127.0.0.1:55680
                    </td>
                    <td style="text-align: left;">
                        <strong>Workers:</strong> 6
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Dashboard:</strong> <a href="http://127.0.0.1:8787/status" target="_blank">http://127.0.0.1:8787/status</a>
                    </td>
                    <td style="text-align: left;">
                        <strong>Total threads:</strong> 6
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Started:</strong> Just now
                    </td>
                    <td style="text-align: left;">
                        <strong>Total memory:</strong> 16.00 GiB
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <details style="margin-left: 48px;">
        <summary style="margin-bottom: 20px;">
            <h3 style="display: inline;">Workers</h3>
        </summary>


        <div style="margin-bottom: 20px;">
            <div style="width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;"> </div>
            <div style="margin-left: 48px;">
            <details>
                <summary>
                    <h4 style="margin-bottom: 0px; display: inline;">Worker: 0</h4>
                </summary>
                <table style="width: 100%; text-align: left;">
                    <tr>
                        <td style="text-align: left;">
                            <strong>Comm: </strong> tcp://127.0.0.1:55696
                        </td>
                        <td style="text-align: left;">
                            <strong>Total threads: </strong> 1
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Dashboard: </strong> <a href="http://127.0.0.1:55699/status" target="_blank">http://127.0.0.1:55699/status</a>
                        </td>
                        <td style="text-align: left;">
                            <strong>Memory: </strong> 2.67 GiB
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Nanny: </strong> tcp://127.0.0.1:55683
                        </td>
                        <td style="text-align: left;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: left;">
                            <strong>Local directory: </strong> /Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-fcd0uyfn
                        </td>
                    </tr>





                </table>
            </details>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <div style="width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;"> </div>
            <div style="margin-left: 48px;">
            <details>
                <summary>
                    <h4 style="margin-bottom: 0px; display: inline;">Worker: 1</h4>
                </summary>
                <table style="width: 100%; text-align: left;">
                    <tr>
                        <td style="text-align: left;">
                            <strong>Comm: </strong> tcp://127.0.0.1:55697
                        </td>
                        <td style="text-align: left;">
                            <strong>Total threads: </strong> 1
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Dashboard: </strong> <a href="http://127.0.0.1:55700/status" target="_blank">http://127.0.0.1:55700/status</a>
                        </td>
                        <td style="text-align: left;">
                            <strong>Memory: </strong> 2.67 GiB
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Nanny: </strong> tcp://127.0.0.1:55688
                        </td>
                        <td style="text-align: left;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: left;">
                            <strong>Local directory: </strong> /Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-mb_nheaa
                        </td>
                    </tr>





                </table>
            </details>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <div style="width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;"> </div>
            <div style="margin-left: 48px;">
            <details>
                <summary>
                    <h4 style="margin-bottom: 0px; display: inline;">Worker: 2</h4>
                </summary>
                <table style="width: 100%; text-align: left;">
                    <tr>
                        <td style="text-align: left;">
                            <strong>Comm: </strong> tcp://127.0.0.1:55703
                        </td>
                        <td style="text-align: left;">
                            <strong>Total threads: </strong> 1
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Dashboard: </strong> <a href="http://127.0.0.1:55706/status" target="_blank">http://127.0.0.1:55706/status</a>
                        </td>
                        <td style="text-align: left;">
                            <strong>Memory: </strong> 2.67 GiB
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Nanny: </strong> tcp://127.0.0.1:55684
                        </td>
                        <td style="text-align: left;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: left;">
                            <strong>Local directory: </strong> /Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-dkhwfke6
                        </td>
                    </tr>





                </table>
            </details>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <div style="width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;"> </div>
            <div style="margin-left: 48px;">
            <details>
                <summary>
                    <h4 style="margin-bottom: 0px; display: inline;">Worker: 3</h4>
                </summary>
                <table style="width: 100%; text-align: left;">
                    <tr>
                        <td style="text-align: left;">
                            <strong>Comm: </strong> tcp://127.0.0.1:55705
                        </td>
                        <td style="text-align: left;">
                            <strong>Total threads: </strong> 1
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Dashboard: </strong> <a href="http://127.0.0.1:55709/status" target="_blank">http://127.0.0.1:55709/status</a>
                        </td>
                        <td style="text-align: left;">
                            <strong>Memory: </strong> 2.67 GiB
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Nanny: </strong> tcp://127.0.0.1:55685
                        </td>
                        <td style="text-align: left;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: left;">
                            <strong>Local directory: </strong> /Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-w9dz_epm
                        </td>
                    </tr>





                </table>
            </details>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <div style="width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;"> </div>
            <div style="margin-left: 48px;">
            <details>
                <summary>
                    <h4 style="margin-bottom: 0px; display: inline;">Worker: 4</h4>
                </summary>
                <table style="width: 100%; text-align: left;">
                    <tr>
                        <td style="text-align: left;">
                            <strong>Comm: </strong> tcp://127.0.0.1:55707
                        </td>
                        <td style="text-align: left;">
                            <strong>Total threads: </strong> 1
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Dashboard: </strong> <a href="http://127.0.0.1:55711/status" target="_blank">http://127.0.0.1:55711/status</a>
                        </td>
                        <td style="text-align: left;">
                            <strong>Memory: </strong> 2.67 GiB
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Nanny: </strong> tcp://127.0.0.1:55687
                        </td>
                        <td style="text-align: left;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: left;">
                            <strong>Local directory: </strong> /Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-1m0sg0bx
                        </td>
                    </tr>





                </table>
            </details>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <div style="width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;"> </div>
            <div style="margin-left: 48px;">
            <details>
                <summary>
                    <h4 style="margin-bottom: 0px; display: inline;">Worker: 5</h4>
                </summary>
                <table style="width: 100%; text-align: left;">
                    <tr>
                        <td style="text-align: left;">
                            <strong>Comm: </strong> tcp://127.0.0.1:55695
                        </td>
                        <td style="text-align: left;">
                            <strong>Total threads: </strong> 1
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Dashboard: </strong> <a href="http://127.0.0.1:55698/status" target="_blank">http://127.0.0.1:55698/status</a>
                        </td>
                        <td style="text-align: left;">
                            <strong>Memory: </strong> 2.67 GiB
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Nanny: </strong> tcp://127.0.0.1:55686
                        </td>
                        <td style="text-align: left;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: left;">
                            <strong>Local directory: </strong> /Users/dcherian/work/eddydiff/notebooks/dask-worker-space/worker-niko7llp
                        </td>
                    </tr>





                </table>
            </details>
            </div>
        </div>


    </details>
</div>

        </details>
    </div>
</div>
            </details>


    </div>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;../images/natre-large-scale.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/natre_3_0.png" src="_images/natre_3_0.png" />
</div>
</div>
<div class="section" id="compute-natre-microstructure-terms">
<h2>Compute NATRE microstructure terms<a class="headerlink" href="#compute-natre-microstructure-terms" title="Permalink to this headline">¶</a></h2>
<p>In theory, these bins are approx. 100m apart in neutral density</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">natre</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">natre</span><span class="o">.</span><span class="n">read_natre</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">)</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">choose_bins</span><span class="p">(</span><span class="n">natre</span><span class="o">.</span><span class="n">gamma_n</span><span class="p">,</span> <span class="n">depth_range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">2001</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="n">natre</span><span class="o">.</span><span class="n">gamma_n</span><span class="o">.</span><span class="n">stack</span><span class="p">({</span><span class="s2">&quot;latlon&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">]})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;latlon&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;latlon&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">add_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">yincrease</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">dcpy</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">linex</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OMP: Info #271: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.
OMP: Info #271: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.
OMP: Info #271: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.
OMP: Info #271: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">raise_if_dask_computes</span><span class="p">():</span>
    <span class="n">micro</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">bin_average_vertical</span><span class="p">(</span>
        <span class="n">natre</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">stack</span><span class="p">({</span><span class="s2">&quot;cast&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">)})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;cast&quot;</span><span class="p">),</span>
        <span class="s2">&quot;neutral_density&quot;</span><span class="p">,</span>
        <span class="n">bins</span><span class="p">,</span>
    <span class="p">)</span>
<span class="c1"># micro.pres.attrs[&quot;bounds&quot;] = &quot;pres_err&quot;</span>
<span class="n">micro</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">micro</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="n">client</span><span class="p">)</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s2">&quot;../datasets/natre-density-binned.nc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OMP: Info #271: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.
OMP: Info #271: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="prepare-various-production-and-dissipation-terms">
<h2>Prepare various production and dissipation terms<a class="headerlink" href="#prepare-various-production-and-dissipation-terms" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">micro</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;../datasets/natre-density-binned.nc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">natre_fine</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;../datasets/natre-finescale.nc&quot;</span><span class="p">)</span>
<span class="n">natre_fine_avg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">natre_fine</span><span class="o">.</span><span class="n">groupby_bins</span><span class="p">(</span><span class="s2">&quot;pressure&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">2001</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">guess_coord_axis</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">natre_fine_avg</span><span class="o">.</span><span class="n">pressure_bins</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="s2">&quot;down&quot;</span><span class="p">,</span>
    <span class="s2">&quot;standard_name&quot;</span><span class="p">:</span> <span class="s2">&quot;sea_water_pressure&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">argo_fine_profiles</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span>
    <span class="s2">&quot;../datasets/argomix_natre.zarr&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;zarr&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;DIRECTION&quot;</span><span class="p">)</span>
<span class="n">argo_fine_profiles</span><span class="p">[</span><span class="s2">&quot;Kt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">argo_fine_profiles</span><span class="p">[</span><span class="s2">&quot;Kρ&quot;</span><span class="p">]</span>
<span class="n">argo_fine_profiles</span><span class="p">[</span><span class="s2">&quot;Kt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$K_T$&quot;</span>
<span class="c1"># argo_fine_profiles = argo_fine_profiles.where(argo_fine_profiles.ε &lt; 0.1)</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">cfxr</span><span class="o">.</span><span class="n">bounds_to_vertices</span><span class="p">(</span><span class="n">micro</span><span class="o">.</span><span class="n">gamma_n_bounds</span><span class="p">,</span> <span class="s2">&quot;bound&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="n">argo_fine_dens</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">argo_fine_profiles</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;γmean&quot;</span><span class="p">:</span> <span class="s2">&quot;gamma_n&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="s2">&quot;pressure&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">groupby_bins</span><span class="p">(</span><span class="s2">&quot;gamma_n&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">argo_fine_dens</span><span class="p">[</span><span class="s2">&quot;gamma_n_bins&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;standard_name&quot;</span><span class="p">:</span> <span class="s2">&quot;neutral_density&quot;</span><span class="p">,</span>
    <span class="s2">&quot;axis&quot;</span><span class="p">:</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;positive&quot;</span><span class="p">:</span> <span class="s2">&quot;down&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">argo_fine_dens</span><span class="p">[</span><span class="s2">&quot;npts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">argo_fine_profiles</span><span class="o">.</span><span class="n">χ</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;γmean&quot;</span><span class="p">:</span> <span class="s2">&quot;gamma_n&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">groupby_bins</span><span class="p">(</span><span class="s2">&quot;gamma_n&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">argo_fine_dens</span> <span class="o">=</span> <span class="n">argo_fine_dens</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="s2">&quot;pressure&quot;</span><span class="p">)</span>

<span class="n">argo_fine_depth</span> <span class="o">=</span> <span class="n">argo_fine_profiles</span><span class="o">.</span><span class="n">groupby_bins</span><span class="p">(</span>
    <span class="s2">&quot;pressure&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">2050</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">argo_fine_depth</span><span class="p">[</span><span class="s2">&quot;pressure_bins&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;standard_name&quot;</span><span class="p">:</span> <span class="s2">&quot;sea_water_pressure&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/dcherian/mambaforge/envs/eddydiff/lib/python3.9/site-packages/pandas/core/arrays/interval.py:1388: RuntimeWarning: deallocating CachingFileManager(&lt;class &#39;netCDF4._netCDF4.Dataset&#39;&gt;, &#39;/Users/dcherian/work/eddydiff/datasets/natre_large_scale.nc&#39;, mode=&#39;r&#39;, kwargs={&#39;clobber&#39;: True, &#39;diskless&#39;: False, &#39;persist&#39;: False, &#39;format&#39;: &#39;NETCDF4&#39;}), but file is not already closed. This may indicate a bug.
  result[i] = Interval(left[i], right[i], closed)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pop_natre</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;../datasets/natre-pop-variance.nc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pop_1deg_natre</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;../datasets/pop-1deg-redivar-natre.nc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This uses a crappier gradient.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cole</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">read_cole</span><span class="p">()</span>

<span class="c1"># read, take mean in region; swap to pressure coordinate</span>
<span class="n">argograd</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s2">&quot;../datasets/cole-clim-gradient-natre.nc&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="s2">&quot;pres&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">360</span> <span class="o">-</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">25</span><span class="p">))</span>
<span class="p">)</span>

<span class="n">cole_natre</span> <span class="o">=</span> <span class="n">cole</span><span class="p">[[</span><span class="s2">&quot;diffusivity&quot;</span><span class="p">,</span> <span class="s2">&quot;density_mean_depth&quot;</span><span class="p">,</span> <span class="s2">&quot;depth_mean_sig&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
    <span class="n">lat</span><span class="o">=</span><span class="n">argograd</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">argograd</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">data</span>
<span class="p">)</span>

<span class="c1"># move from sigma to depth space</span>
<span class="n">argo_dTiso</span> <span class="o">=</span> <span class="n">xgcm</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">linear_interpolation</span><span class="p">(</span>
    <span class="n">argograd</span><span class="o">.</span><span class="n">dTiso</span><span class="p">,</span>
    <span class="n">argograd</span><span class="o">.</span><span class="n">pres</span><span class="p">,</span>
    <span class="n">cole</span><span class="o">.</span><span class="n">pres</span><span class="p">,</span>
    <span class="s2">&quot;sigma&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sigma&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pres&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">cole_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">cole_natre</span><span class="o">.</span><span class="n">diffusivity</span> <span class="o">*</span> <span class="n">argo_dTiso</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">])</span>
<span class="n">cole_var</span><span class="p">[</span><span class="s2">&quot;pres&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cole_natre</span><span class="p">[</span><span class="s2">&quot;pres&quot;</span><span class="p">]</span>
<span class="n">cole_var</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;$K_e^</span><span class="si">{cole}</span><span class="s2"> |∇T_</span><span class="si">{iso}</span><span class="s2">^</span><span class="si">{argo}</span><span class="s2">|²$&quot;</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;°C²/s&quot;</span><span class="p">}</span>

<span class="n">groeskamp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s2">&quot;~/datasets/groeskamp2020/groeskamp2020.nc&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">360</span> <span class="o">-</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">25</span><span class="p">))</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="s2">&quot;pres&quot;</span><span class="p">})</span>
<span class="p">)</span>
<span class="n">groeskamp</span><span class="p">[</span><span class="s2">&quot;dTiso&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">argo_dTiso</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">pres</span><span class="o">=</span><span class="n">groeskamp</span><span class="o">.</span><span class="n">pres</span><span class="p">)</span>
<span class="n">groeskamp</span><span class="p">[</span><span class="s2">&quot;eddy_var_0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">groeskamp</span><span class="p">[</span><span class="s2">&quot;Ke_0&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">groeskamp</span><span class="o">.</span><span class="n">dTiso</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">groeskamp</span><span class="p">[</span><span class="s2">&quot;eddy_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">groeskamp</span><span class="p">[</span><span class="s2">&quot;Ke&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">groeskamp</span><span class="o">.</span><span class="n">dTiso</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">groeskamp</span> <span class="o">=</span> <span class="n">groeskamp</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/dcherian/work/python/xarray/xarray/core/indexing.py:549: RuntimeWarning: deallocating CachingFileManager(&lt;class &#39;netCDF4._netCDF4.Dataset&#39;&gt;, &#39;/Users/dcherian/datasets/groeskamp2020/groeskamp2020.nc&#39;, mode=&#39;r&#39;, kwargs={&#39;clobber&#39;: True, &#39;diskless&#39;: False, &#39;persist&#39;: False, &#39;format&#39;: &#39;NETCDF4&#39;}), but file is not already closed. This may indicate a bug.
  self.array = NumpyIndexingAdapter(np.asarray(self.array))
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="pop-1-10-vs-pop-1">
<h2>POP 1/10 vs POP 1<a class="headerlink" href="#pop-1-10-vs-pop-1" title="Permalink to this headline">¶</a></h2>
<p>Smooth 1/10∂egree to 1degree hydrography and then compare delT2 at the scale of 1 degree model.</p>
<p>1degree model has 1/N2 dependence</p>
<p>scott’s work to invert kappa</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">140</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.facecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.facecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.99</span><span class="p">,)</span><span class="o">*</span><span class="mi">3</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;grid.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span><span class="o">*</span><span class="mi">3</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;grid.alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;grid.linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>


<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="n">pop_1deg_natre</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">cycle</span><span class="o">=</span><span class="n">cycle</span><span class="p">)</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">z_t</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">add_bounds</span><span class="p">(</span><span class="s2">&quot;z_t&quot;</span><span class="p">)</span>
    <span class="n">ybounds</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">z_t_bounds</span>
    <span class="n">bdim</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">get_bounds_dim_name</span><span class="p">(</span><span class="s2">&quot;z_t&quot;</span><span class="p">)</span>
    <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ybounds</span><span class="o">.</span><span class="n">isel</span><span class="p">({</span><span class="n">bdim</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ybounds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">stairs</span><span class="p">(</span>
        <span class="n">pop</span><span class="o">.</span><span class="n">RediVar</span><span class="p">,</span>
        <span class="n">edges</span><span class="o">=</span><span class="n">yedges</span><span class="p">,</span>
        <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;POP 1° cycle=</span><span class="si">{</span><span class="n">cycle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

<span class="n">mesomicrocolor</span> <span class="o">=</span> <span class="s2">&quot;darkorchid&quot;</span>
<span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">pop_natre</span><span class="o">.</span><span class="n">DISS</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">mesomicrocolor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;POP 1/10°&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/natre_18_0.png" src="_images/natre_18_0.png" />
</div>
</div>
</div>
<div class="section" id="variance-production-vs-dissipation">
<h2>Variance production vs dissipation<a class="headerlink" href="#variance-production-vs-dissipation" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p>Agreement between POP “mesoscale variance dissipation” and microstructure estimate of “variance received from mesoscale” is great! (Purple dashed steps agree well with purple solid line)</p></li>
<li><p>POP’s grid-scale temp variance dissipation is really dominated by the horizontal biharmonic diffusion, but fundamentally the amount of mesoscale variance destroyed by grid-scale diffusion matches that in the microstructure measurements.</p></li>
<li><p>One place of disagreement is between 400m and 700m where the POP estimate is really small compared to my difference. <strong>FP2005 also see this using the mooring based Ke estimate</strong>. At these levels their two terms also match a lot closer than mine, so there’s an error somewhere. It seems like my <span class="math notranslate nohighlight">\(⟨χ⟩/2\)</span> is a little bit too high which happened after I switched to the bootstrapping based estimates. I’ve made some improvements</p>
<ol class="simple">
<li><p>Sorting the dataset, changes the mean density field used to pick the bins.</p></li>
<li><p>Calculating <span class="math notranslate nohighlight">\((∂T/∂z)_m\)</span> is a little wonky. I now use a different procedure. In each O(100m) <span class="math notranslate nohighlight">\(γ_n\)</span> bin, I groupby finer-resolution <span class="math notranslate nohighlight">\(γ_n\)</span> bins (21 of them), calculate the mean profile, then fit a straight line.</p></li>
</ol>
</li>
<li><p>Cole/Groeskamp <span class="math notranslate nohighlight">\(K_e\)</span> estimate based variance dissipation compares much better now.</p>
<ol class="simple">
<li><p>~Comparing to variance dissipated by parameterizations for <span class="math notranslate nohighlight">\(K_e\)</span> (<span class="math notranslate nohighlight">\(K_e |∇_hT|²\)</span>) doesn’t work well. I wonder if I’m doing something wrong with my <span class="math notranslate nohighlight">\(∇_hT\)</span> estimate~</p></li>
<li><p>I updated my |∇T| estimation code; now estimate along-isopycnal gradients in σ space instead of just a lateral gradient</p></li>
<li><p>While the current algo still doesn’t match Silvia’s ∇S (but much better than earlier), it seems to improve agreement (panel c)</p></li>
</ol>
</li>
</ol>
<div class="cell tag_hide-input tag_full-width docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">micro</span><span class="o">.</span><span class="n">pres</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pres_err&quot;</span>

<span class="k">def</span> <span class="nf">plot_pop_natre_meso_micro</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">mesomicrocolor</span> <span class="o">=</span> <span class="s2">&quot;darkorchid&quot;</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">pop_natre</span><span class="o">.</span><span class="n">DISS</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">mesomicrocolor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;POP meso $→$ micro&quot;</span>
    <span class="p">)</span>

    <span class="n">dcpy</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">fill_between_bounds</span><span class="p">(</span>
        <span class="n">micro</span><span class="p">,</span>
        <span class="s2">&quot;residual&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">mesomicrocolor</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;NATRE meso $→$ micro&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="p">)</span>


<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1">### Mesoscale budget</span>
<span class="n">pop_natre</span><span class="o">.</span><span class="n">BC</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;POP h. stir $⟨u_e^h θ_e⟩.∇_hθ_m$&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">pop_natre</span><span class="o">.</span><span class="n">PKC</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;POP v. stir $-⟨w_eθ_e⟩.∂_zθ_m$&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">pop_natre</span><span class="o">.</span><span class="n">VMIX</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;sienna&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;POP VMIX&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">pop_natre</span><span class="o">.</span><span class="n">HDIFF</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;POP HDIFF&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>


<span class="c1">### Microscale budget</span>
<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="n">dcpy</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">fill_between_bounds</span><span class="p">(</span>
    <span class="n">micro</span><span class="p">,</span> <span class="s2">&quot;KρTz2&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FP2005: $K_ρ  ∂_zθ_m^2$&quot;</span>
<span class="p">)</span>
<span class="n">dcpy</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">fill_between_bounds</span><span class="p">(</span>
    <span class="n">micro</span><span class="p">,</span> <span class="s2">&quot;chib2&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FP2005: $⟨χ⟩/2$&quot;</span>
<span class="p">)</span>

<span class="c1"># (micro.chi / 2).cf.plot.step(</span>
<span class="c1">#    y=&quot;pres&quot;,</span>
<span class="c1">#    color=&quot;r&quot;,</span>
<span class="c1">#    lw=2,</span>
<span class="c1">#    xlim=(1e-11, 1e-8),</span>
<span class="c1">#    ylim=(1800, 200),</span>
<span class="c1"># )</span>
<span class="c1"># (micro.Krho_m * micro.dTdz_m ** 2).cf.plot.step(</span>
<span class="c1">#    color=&quot;k&quot;,</span>
<span class="c1">#    lw=2,</span>
<span class="c1">#    y=&quot;pres&quot;,</span>
<span class="c1"># )</span>
<span class="c1"># (argo_fine_depth.χ.sel(criteria=&quot;whalen&quot;) / 2).cf.plot.step(</span>
<span class="c1">#    marker=&quot;o&quot;,</span>
<span class="c1">#    color=&quot;C1&quot;,</span>
<span class="c1">#    ax=plt.gca(),</span>
<span class="c1">#    y=&quot;pressure_bins&quot;,</span>
<span class="c1">#    label=&quot;$⟨χ⟩^{argo}_{Rω=3}/2$&quot;,</span>
<span class="c1"># )</span>

<span class="c1">### Parameterizations</span>
<span class="n">cole_var</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$K_e^</span><span class="si">{cole}</span><span class="s2"> |∇_hT^</span><span class="si">{cole}</span><span class="s2">|²$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">groeskamp</span><span class="o">.</span><span class="n">eddy_var_0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$K_e^</span><span class="si">{G2020unsupp}</span><span class="s2"> |∇_hT^</span><span class="si">{cole}</span><span class="s2">|²$&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;limegreen&quot;</span><span class="p">,</span>
    <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">groeskamp</span><span class="o">.</span><span class="n">eddy_var</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$K_e^</span><span class="si">{G2020}</span><span class="s2"> |∇_hT^</span><span class="si">{cole}</span><span class="s2">|²$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;limegreen&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1">### Cleanup</span>
<span class="k">for</span> <span class="n">axx</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
    <span class="n">plot_pop_natre_meso_micro</span><span class="p">(</span><span class="n">axx</span><span class="p">)</span>
    <span class="n">axx</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">axx</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">axx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">))</span>
    <span class="n">axx</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Variance production or dissipation [°C²/s]&quot;</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;NATRE&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;(a) Mesoscale budget&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;(b) Microscale budget&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;(c) Parameterizations&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">1e-11</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">1900</span><span class="p">,</span> <span class="mi">180</span><span class="p">])</span>

<span class="n">dcpy</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">clean_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">9.2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../images/natre-meso-micro-param.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/natre_20_0.png" src="_images/natre_20_0.png" />
</div>
</div>
<div class="section" id="interpretation">
<h3>Interpretation<a class="headerlink" href="#interpretation" title="Permalink to this headline">¶</a></h3>
<div class="section" id="spicy-region">
<h4>Spicy region<a class="headerlink" href="#spicy-region" title="Permalink to this headline">¶</a></h4>
<p>We can interpret the red mesoscale dissipation term in (b) as the amount of variance transferred to the microscale for eventual dissipation. This peaks in regions of high mean spice between 1000m and 1500m. The balance in spicy regions is that horizontal mesoscale stirring converts MPE → EPE (compensated filaments or T-S variance) that is dissipated by the microscale. The approximate budget is (note vertical stirring gets ignored, and <span class="math notranslate nohighlight">\(u^h\)</span> represents horizontal velocity vector)</p>
<div class="amsmath math notranslate nohighlight" id="equation-4680da63-2693-4e23-bed7-0f5f758ad48f">
<span class="eqno">(3)<a class="headerlink" href="#equation-4680da63-2693-4e23-bed7-0f5f758ad48f" title="Permalink to this equation">¶</a></span>\[\begin{align}
⟨u^h_eT_e⟩ ⋅ ∇_hT_m - ⟨\widetilde{u_t T_t} ⋅ ∇T_e⟩ &amp;\approx 0 \\
⟨\widetilde{u_t T_t} ⋅ ∇ T_e⟩ &amp;\approx - \frac 12 ⟨χ⟩
\end{align}\]</div>
<ol class="simple">
<li><p>Yiming sees the first equation as “lateral stirring” balances “mesoscale dissipation”, and</p></li>
<li><p>FP2005 combine the two equations to conclude that “mesoscale stirring of mean variance” balances “total microscale dissipation”</p></li>
</ol>
</div>
<div class="section" id="weak-spice">
<h4>Weak spice<a class="headerlink" href="#weak-spice" title="Permalink to this headline">¶</a></h4>
<p>In the upper water column that is not spicy, we instead see horizontal stirring MPE→ EPE which is then routed to EKE by “vertical stirring”. Here the scale transformation term is 0 so the budget is</p>
<div class="amsmath math notranslate nohighlight" id="equation-13e27517-8524-409c-84e1-14a2294465bb">
<span class="eqno">(4)<a class="headerlink" href="#equation-13e27517-8524-409c-84e1-14a2294465bb" title="Permalink to this equation">¶</a></span>\[\begin{align}
⟨u_eT_e⟩ ⋅ ∇T_m &amp;\approx 0 \\
⟨u_tT_t⟩ ⋅ ∇ T_m &amp;\approx - \frac 12 ⟨χ⟩
\end{align}\]</div>
<ol class="simple">
<li><p>Yiming sees the first equation as “low dissipation” or “lateral stirring balances vertical stirring”;</p></li>
<li><p>FP2005 sees the second equation as “microscale stirring of the mean” balances “total microscale dissipation”</p></li>
</ol>
</div>
</div>
<div class="section" id="next-steps">
<h3>Next steps:<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>[ ] Microscale variance budget</p>
<ol class="simple">
<li><p>Could estimate  <span class="math notranslate nohighlight">\(⟨u_t T_t⟩ ⋅ ∇T_m = -⟨K_t  T_z⟩ T_z^m\)</span> term (monthly mean heat flux X monthly mean vertical gradient) using the model; just like I do with  the microstructure data.</p></li>
<li><p>Then add the mesoscale dissipation term to get total <span class="math notranslate nohighlight">\(⟨χ⟩\)</span></p></li>
</ol>
</li>
<li><p>[x] Put observation, model, parameterization estimates on same figure; Add Cole / Groeskamp estimate of <span class="math notranslate nohighlight">\(K_e |∇T_m|^2\)</span></p></li>
</ol>
</div>
</div>
<div class="section" id="all-microscale-budget-terms">
<h2>All microscale budget terms<a class="headerlink" href="#all-microscale-budget-terms" title="Permalink to this headline">¶</a></h2>
<p><strong>Microscale budget:</strong></p>
<ul class="simple">
<li><p>Ferrari &amp; Polzin use <span class="math notranslate nohighlight">\(⟨u_t θ_t⟩.∇θ_m = -Γ ⟨ε⟩/N_m^2  ∂_zθ_m^2\)</span>, we are instead doing <span class="math notranslate nohighlight">\(-⟨K_T θ_z⟩ ∂_zθ_m\)</span>.</p></li>
<li><p>Our estimate mostly agrees with theirs (crosses versus solid-line-steps).</p>
<ol class="simple">
<li><p>Filling in NaNs in the temperature profiles was important. This means more estimates are used in the averages</p></li>
<li><p>Masked where both <span class="math notranslate nohighlight">\(χ\)</span> and <span class="math notranslate nohighlight">\(ε\)</span> are both available.</p></li>
<li><p>Masked so that <span class="math notranslate nohighlight">\(|θ_z|\)</span> &gt; 1e-3 (really important, otherwise our estimate is too high)</p></li>
</ol>
</li>
</ul>
<p><strong>Variance produced by parameterizations for eddy diffusivity:</strong></p>
<ul class="simple">
<li><p>The comparison with variance production using Cole et al diffusivity and gradients calculated in a similar way disagree significantly between 400 and 1000m. Below that there’s not much data but it seems to agree.</p></li>
<li><p>The Groeskamp et al (2020) estimate [G2020] is slightly better but not by much. All predict a maximum in variance production near 800m</p></li>
</ul>
<p><strong>⟨χ⟩ estimate using finescale parameterizations:</strong></p>
<ul class="simple">
<li><p>The finescale estimates are interesting, argo with Rω=3 and natre with Rω=7 work well but why?</p></li>
<li><p>There is some interesting discrepancy here. This choice of <span class="math notranslate nohighlight">\(Rω\)</span> makes for a factor of 2 difference which would hide the mesoscale→microscale transformation.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># , constrained_layout=True)</span>

<span class="p">(</span><span class="n">micro</span><span class="o">.</span><span class="n">chi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FP: $⟨χ⟩/2$&quot;</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-11</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">),</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">1800</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
<span class="p">)</span>
<span class="p">(</span><span class="n">micro</span><span class="o">.</span><span class="n">Krho_m</span> <span class="o">*</span> <span class="n">micro</span><span class="o">.</span><span class="n">dTdz_m</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FP: $Γ ⟨ε⟩/N_m^2  ∂_zθ_m^2$&quot;</span>
<span class="p">)</span>

<span class="n">cole_var</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$K_e^</span><span class="si">{cole}</span><span class="s2"> |∇T^</span><span class="si">{cole}</span><span class="s2">|²$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

<span class="n">groeskamp</span><span class="o">.</span><span class="n">eddy_var_0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$K_e^</span><span class="si">{G2020unsupp}</span><span class="s2"> |∇T^</span><span class="si">{cole}</span><span class="s2">|²$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;teal&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span>
<span class="p">)</span>
<span class="n">groeskamp</span><span class="o">.</span><span class="n">eddy_var</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$K_e^</span><span class="si">{G2020}</span><span class="s2"> |∇T^</span><span class="si">{cole}</span><span class="s2">|²$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;teal&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span>
<span class="p">)</span>

<span class="n">ed</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">plot_var_prod_diss</span><span class="p">(</span><span class="n">micro</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>

<span class="p">(</span><span class="n">argo_fine_depth</span><span class="o">.</span><span class="n">χ</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="s2">&quot;whalen&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pressure_bins&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$⟨χ⟩^</span><span class="si">{argo}</span><span class="s2">_{Rω=3}/2$&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># (natre_fine_avg.χ.sel(criteria=&quot;whalen&quot;) / 2).cf.plot.step(</span>
<span class="c1">#    marker=&quot;o&quot;, color=&quot;C2&quot;, ax=plt.gca(), label=&quot;$⟨χ⟩_{fine-3}^{natre}/2$&quot;</span>
<span class="c1"># )</span>
<span class="p">(</span><span class="n">natre_fine_avg</span><span class="o">.</span><span class="n">χ</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="s2">&quot;whalen_7&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$⟨χ⟩_{Rω=7}^</span><span class="si">{natre}</span><span class="s2">/2$&quot;</span>
<span class="p">)</span>

<span class="c1"># (micro.chi / 2 - micro.Krho * micro.dTdz ** 2).cf.plot.step(</span>
<span class="c1">#    y=&quot;pres&quot;,</span>
<span class="c1">#   xscale=&quot;log&quot;,</span>
<span class="c1">#   xlim=(1e-11, 1e-8),</span>
<span class="c1">#   ylim=(1800, 200),</span>
<span class="c1">#   color=&quot;darkblue&quot;,</span>
<span class="c1">#   lw=1,</span>
<span class="c1">#   label=&quot;$⟨χ⟩/2 - K_ρ θ^m_z$&quot;,</span>
<span class="c1"># )</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.6</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Variance production or dissipation [°C²/s]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;NATRE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../images/natre-estimate.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/natre_24_0.png" src="_images/natre_24_0.png" />
</div>
</div>
</div>
<div class="section" id="pop2-1-10-mesoscale-variance-budget">
<h2>POP2 1/10° mesoscale variance budget<a class="headerlink" href="#pop2-1-10-mesoscale-variance-budget" title="Permalink to this headline">¶</a></h2>
<p>Yiming is working with the following variance budget equation for the mesoscale after decomposing <span class="math notranslate nohighlight">\(T = \bar{T} + T' + T'' ≡ T_m + T_e + T_t\)</span> (the latter is Ferrari &amp; Polzin notation). The <span class="math notranslate nohighlight">\(T = \tilde{T} + T''\)</span> decomposition is inherent when using cell-averaged equations.</p>
<div class="amsmath math notranslate nohighlight" id="equation-51a28296-875e-4c13-ab99-f5d6ba55120c">
<span class="eqno">(5)<a class="headerlink" href="#equation-51a28296-875e-4c13-ab99-f5d6ba55120c" title="Permalink to this equation">¶</a></span>\[\begin{equation}
∂_t \overline{T'^2} =  -\overline{u'T'} ⋅ ∇_h\overline{T} - \overline{w'T'}∂_z\overline{T} - \overline{\vec{v} ⋅ ∇ T'^2/2} + \overline{T'∂_z \left[K ∂_zT' \right]} + …
\end{equation}\]</div>
<p>Ferrari &amp; Polzin’s equations (4.6, 4.7) for the mesoscale and microscale are (<span class="math notranslate nohighlight">\(u\)</span> here is the full 3D <span class="math notranslate nohighlight">\(u\)</span>):</p>
<div class="amsmath math notranslate nohighlight" id="equation-d01f7225-8583-4058-a496-50c959fad1ed">
<span class="eqno">(6)<a class="headerlink" href="#equation-d01f7225-8583-4058-a496-50c959fad1ed" title="Permalink to this equation">¶</a></span>\[\begin{align}
⟨u_eT_e⟩ ⋅ ∇T_m - ⟨\widetilde{u_t T_t} ⋅ ∇T_e⟩ &amp;= 0 \\
⟨u_tT_t⟩ ⋅ ∇ T_m + ⟨\widetilde{u_t T_t} ⋅ ∇ T_e⟩ &amp;= - \frac 12 ⟨χ⟩
\end{align}\]</div>
<p>Note that these equations are specialized for the “interior”.</p>
<p>For the model the averaging scales are:</p>
<ol class="simple">
<li><p>~: grid-scale in vertical; single time-step in time i.e. the “microscale” is the “grid-scale”</p></li>
<li><p>⟨⟩: monthly in time; NATRE domain size in (x,y)</p></li>
</ol>
<p>In Yiming’s notation these equations are</p>
<div class="amsmath math notranslate nohighlight" id="equation-21f2ba6e-b6e7-490b-9c22-9036bb34ac02">
<span class="eqno">(7)<a class="headerlink" href="#equation-21f2ba6e-b6e7-490b-9c22-9036bb34ac02" title="Permalink to this equation">¶</a></span>\[\begin{align}
\overline{u'T'}⋅∇\overline{T} + \overline{w'T'}∂_z\overline{T}  - \overline{T'∂_z \left[K ∂_zT' \right]} = 0 \\
K \left(∂_z(\overline{T} + T')\right)^2  &amp;= - \frac 12 ⟨χ⟩
\end{align}\]</div>
<p>Now we can identify Yiming’s dissipation term (“VMIX”, ignoring solar heating etc.) as the scale transformation term in FP2005 and then use the microscale budget from FP2005 to write</p>
<div class="amsmath math notranslate nohighlight" id="equation-e665bcb4-a336-498c-8093-f016433b7108">
<span class="eqno">(8)<a class="headerlink" href="#equation-e665bcb4-a336-498c-8093-f016433b7108" title="Permalink to this equation">¶</a></span>\[\begin{equation}
⟨\widetilde{u_t T_t} ⋅ ∇T_e⟩ = - \frac 12 ⟨χ⟩ - ⟨u_tT_t⟩ ⋅ ∇ T_m
\end{equation}\]</div>
<p>i.e. Yiming’s “mesoscale dissipation” term is really the difference between</p>
<ol class="simple">
<li><p>total microscale dissipation, and</p></li>
<li><p>microscale production by stirring of the mean vertical gradient,</p></li>
</ol>
<p>both of which can be estimated from microstructure observations.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;../images/Tvariance_budget_NATREregion_with_EKE.png&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/natre_26_0.png" src="_images/natre_26_0.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>distributed.utils_perf - WARNING - full garbage collections took 13% CPU time recently (threshold: 10%)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="error-bounds">
<h2>Error bounds<a class="headerlink" href="#error-bounds" title="Permalink to this headline">¶</a></h2>
<div class="section" id="microstructure">
<h3>Microstructure<a class="headerlink" href="#microstructure" title="Permalink to this headline">¶</a></h3>
<p>Ferrari &amp; Polzin (2005):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> The variance of ε (and χ) are calculated using a bootstrap method (Efron 1982). The number of degrees of freedom in the bootstrap estimate is determined from the number of independent vertical segments in the ensemble. The number of independent vertical segments in the 0.5-m ε (and χ) data was estimated using a vertical-lag correlation analysis (St.Laurent and Schmitt 1999). The profiles are characterized by correlation scales of 5 m in the thermocline (&lt; 800 m) and 10 m at greater depths. A single degree of freedom is represented by the grouping of 0.5-m data within one correlation scale in a single profile. For the ensemble of data in each neutral density class, the number of such groupings gives the total degrees of freedom.
</pre></div>
</div>
<p><img alt="image.png" src="attachment:20277b9e-ff35-4540-b7e4-b7ca2046730e.png" /></p>
</div>
</div>
<div class="section" id="studying-cole-estimate">
<h2>Studying Cole estimate<a class="headerlink" href="#studying-cole-estimate" title="Permalink to this headline">¶</a></h2>
<p>Previously I was seeing some big disagreement. This was due to gradients estimated in depth-space instead of in isopycnal space.</p>
<div class="section" id="compare-cole-groeskamp-diffusivities">
<h3>Compare Cole &amp; Groeskamp diffusivities<a class="headerlink" href="#compare-cole-groeskamp-diffusivities" title="Permalink to this headline">¶</a></h3>
<p>Reproducing Groeskamp Figure 1. This seems to work well; but note the different domain. I saw this in his MATLAB script.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span> <span class="n">MIXING</span> <span class="n">IN</span> <span class="n">NATRE</span> <span class="n">REGION</span>
<span class="o">%</span> <span class="n">THE</span> <span class="n">NATRE</span> <span class="n">REGIONS</span> <span class="n">LIES</span> <span class="n">BETWEEN</span>
<span class="o">%</span> <span class="mf">319.5</span> <span class="o">-</span> <span class="mf">344.5</span> <span class="n">degrees</span> <span class="n">lon</span>
<span class="o">%</span>  <span class="mf">19.5</span> <span class="o">-</span>  <span class="mf">29.5</span> <span class="n">degrees</span> <span class="n">lat</span>
<span class="n">NATRE_x</span> <span class="o">=</span> <span class="mi">320</span><span class="p">:</span><span class="mi">345</span><span class="p">;</span>
<span class="n">NATRE_y</span> <span class="o">=</span> <span class="mi">110</span><span class="p">:</span><span class="mi">120</span><span class="p">;</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cole</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">read_cole</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s2">&quot;3deg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
    <span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">19.5</span><span class="p">,</span> <span class="mf">29.5</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">319.5</span><span class="p">,</span> <span class="mf">344.5</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">groeskamp</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s2">&quot;/home/deepak/datasets/groeskamp2020/groeskamp2020.nc&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">19.5</span><span class="p">,</span> <span class="mf">29.5</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">319.5</span><span class="p">,</span> <span class="mf">344.5</span><span class="p">))</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="s2">&quot;pres&quot;</span><span class="p">})</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_mean_std</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">])</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">])</span>
    <span class="p">(</span><span class="n">hdl</span><span class="p">,)</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="n">dcpy</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
        <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">mean</span> <span class="o">-</span> <span class="n">std</span><span class="p">,</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">std</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;err&quot;</span><span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;err&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="p">)</span>


<span class="n">plot_mean_std</span><span class="p">(</span><span class="n">groeskamp</span><span class="o">.</span><span class="n">Ke_0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Groeskamp unsuppressed&quot;</span><span class="p">)</span>
<span class="n">plot_mean_std</span><span class="p">(</span><span class="n">groeskamp</span><span class="o">.</span><span class="n">Ke</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Groeskamp suppressed&quot;</span><span class="p">)</span>
<span class="n">plot_mean_std</span><span class="p">(</span><span class="n">cole</span><span class="o">.</span><span class="n">diffusivity</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cole&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">3000</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/deepak/miniconda3/envs/dcpy/lib/python3.8/site-packages/numpy/lib/nanfunctions.py:1670: RuntimeWarning: Degrees of freedom &lt;= 0 for slice.
  var = nanvar(a, axis=axis, dtype=dtype, out=out, ddof=ddof,
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f6a3f8c57f0&gt;
</pre></div>
</div>
<img alt="_images/natre_31_2.png" src="_images/natre_31_2.png" />
</div>
</div>
</div>
<div class="section" id="depth-vs-density-space-estimation-of-k-e-t-2">
<h3>Depth-vs-density space estimation of <span class="math notranslate nohighlight">\(K_e |∇T|²\)</span><a class="headerlink" href="#depth-vs-density-space-estimation-of-k-e-t-2" title="Permalink to this headline">¶</a></h3>
<p>Turns out this does not matter; I was worried that diffusivity in depth space and |∇T| estimated in density space might combine badly. But moving diffusivity to sigma space or |∇T| to depth space results in same mean variance tendency</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cole</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">read_cole</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">xgcm</span>

<span class="n">cole</span><span class="p">[</span><span class="s2">&quot;diffusivity_sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xgcm</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">linear_interpolation</span><span class="p">(</span>
    <span class="n">cole</span><span class="o">.</span><span class="n">diffusivity</span><span class="p">,</span> <span class="n">cole</span><span class="o">.</span><span class="n">density_mean_depth</span><span class="p">,</span> <span class="n">cole</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span>
<span class="p">)</span>

<span class="c1"># read, take mean in region; swap to pressure coordinate</span>
<span class="n">colegrad</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s2">&quot;../datasets/cole-clim-gradient-natre.nc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
    <span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">360</span> <span class="o">-</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">25</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">colegrad</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cole</span><span class="o">.</span><span class="n">sigma</span>

<span class="n">cole_natre</span> <span class="o">=</span> <span class="n">cole</span><span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;diffusivity&quot;</span><span class="p">,</span> <span class="s2">&quot;diffusivity_sig&quot;</span><span class="p">,</span> <span class="s2">&quot;density_mean_depth&quot;</span><span class="p">,</span> <span class="s2">&quot;depth_mean_sig&quot;</span><span class="p">]</span>
<span class="p">]</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">colegrad</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">colegrad</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">dTiso_pres</span> <span class="o">=</span> <span class="n">xgcm</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">linear_interpolation</span><span class="p">(</span>
    <span class="n">colegrad</span><span class="o">.</span><span class="n">dTiso</span><span class="p">,</span>
    <span class="n">colegrad</span><span class="o">.</span><span class="n">pres</span><span class="p">,</span>
    <span class="n">cole</span><span class="o">.</span><span class="n">pres</span><span class="p">,</span>
    <span class="s2">&quot;sigma&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sigma&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pres&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cole_var_sig</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">cole_natre</span><span class="o">.</span><span class="n">diffusivity_sig</span> <span class="o">*</span> <span class="n">colegrad</span><span class="o">.</span><span class="n">dTiso</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">pres</span><span class="o">=</span><span class="n">cole_natre</span><span class="o">.</span><span class="n">depth_mean_sig</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]))</span>
<span class="p">)</span>
<span class="n">cole_var_pres</span> <span class="o">=</span> <span class="p">(</span><span class="n">cole_natre</span><span class="o">.</span><span class="n">diffusivity</span> <span class="o">*</span> <span class="n">dTiso_pres</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">])</span>

<span class="n">cole_var_sig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">)</span>
<span class="n">cole_var_pres</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">yincrease</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;sigma space&quot;</span><span class="p">,</span> <span class="s2">&quot;depth space&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7fa53eb855b0&gt;
</pre></div>
</div>
<img alt="_images/natre_35_1.png" src="_images/natre_35_1.png" />
</div>
</div>
</div>
<div class="section" id="depth-space-calculation">
<h3>Depth space calculation<a class="headerlink" href="#depth-space-calculation" title="Permalink to this headline">¶</a></h3>
<p>The following is when I was using <span class="math notranslate nohighlight">\(|∇T|\)</span> estimated in depth space and multiplying by a <span class="math notranslate nohighlight">\(K_e\)</span> provided in depth space</p>
<p><strong>Initial surprising observation</strong>: We expect to see peak <span class="math notranslate nohighlight">\(K_e\)</span> between 600 and 1600m but we mostly don’t! Both <span class="math notranslate nohighlight">\(⟨S'S'⟩\)</span> and <span class="math notranslate nohighlight">\(|∇S|\)</span> are large in the depth we expect a peak. There seems to be approximate agreement in the 1000-1200m range at (-34°E, -32°E) but missing data at deeper depths</p>
<p>Here are estimates of variance produced by eddy stirring at points in the NATRE box from Cole et al (2015). There is some spread but the peak between 400 and 1000 seems robust. Thick black line is the mean over the box.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cole_var_all</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">latlon</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;latlon&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">add_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">xscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span>
<span class="p">)</span>
<span class="n">cole_var</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$K_e^</span><span class="si">{cole}</span><span class="s2"> |∇T_</span><span class="si">{iso}</span><span class="s2">^</span><span class="si">{argo}</span><span class="s2">|²$ [°C²/s]&quot;</span><span class="p">)</span>
<span class="c1"># (cole.diffusivity.interp_like(dTiso) * colegrad.dSiso**2).mean([&quot;lat&quot;, &quot;lon&quot;]).cf.plot()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;$K_e^{cole} |∇T_{iso}^{argo}|²$ [°C²/s]&#39;)
</pre></div>
</div>
<img alt="_images/natre_38_1.png" src="_images/natre_38_1.png" />
</div>
</div>
<p>These are the various terms in the Cole analysis. Note minimum in ∇S between 200 and 800, and associated high mixing lengths ≳ 300km.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ed</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot_cole_profile</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mi">360</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">35</span><span class="p">,</span> <span class="o">-</span><span class="mi">34</span><span class="p">,</span> <span class="o">-</span><span class="mi">33</span><span class="p">,</span> <span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">27</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/natre_40_0.png" src="_images/natre_40_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="t-s-diagrams-argo-vs-natre">
<h2>T-S diagrams: Argo vs. NATRE<a class="headerlink" href="#t-s-diagrams-argo-vs-natre" title="Permalink to this headline">¶</a></h2>
<p>Lets compare T-S to see if they are similar. I am exploring ways to</p>
<ol class="simple">
<li><p>interpret the “high” variance production values between 400m and 800m for the Cole estimate. Maybe the NATRE T-S is not representative of the argo T-S?</p>
<ul class="simple">
<li><p>It is representative!</p></li>
</ul>
</li>
<li><p>explain why the Argo ⟨χ⟩ seems to miss any eddy contribution. Is the scatter less at those density levels?</p>
<ul class="simple">
<li><p>There is some undersampling (of course) because the sampling dz is low below 1000m usually.</p></li>
<li><p>It seems to capture some of the spread; but the NATRE dataset seems to fill up the space more.</p></li>
</ul>
</li>
</ol>
<p>The density contours are ρ corresponding to depths <code class="docutils literal notranslate"><span class="pre">np.arange(200,</span> <span class="pre">2000,</span> <span class="pre">200)</span></code> in the Cole dataset. Clearly the top few contours see not much T-S stirring and the T-S relationship is “tight”. Ferrari &amp; Polzin interpreted this as a balance between microscale stirring and dissipation.</p>
<ul class="simple">
<li><p>So the high K_e estimate between 400m and 800m in Cole et al (2015) is not supported by the TS spread.</p></li>
<li><p>Though interestingly the Groeskamp estimate has the same issue then.</p></li>
</ul>
<p>Is the finestructure estimate undersampling eddy stirring periods? Compare T-S spread for</p>
<ol class="simple">
<li><p>all argo profiles</p></li>
<li><p>argo profiles where I can make a finestructure estimate.</p></li>
<li><p>NATRE profiles</p></li>
</ol>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">argo_natre</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;../datasets/argo/natre.nc&quot;</span><span class="p">)</span>
<span class="n">argo_natre</span><span class="p">[</span><span class="s2">&quot;THETA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcpy</span><span class="o">.</span><span class="n">eos</span><span class="o">.</span><span class="n">ptmp</span><span class="p">(</span>
    <span class="n">argo_natre</span><span class="o">.</span><span class="n">PSAL</span><span class="p">,</span> <span class="n">argo_natre</span><span class="o">.</span><span class="n">TEMP</span><span class="p">,</span> <span class="n">argo_natre</span><span class="o">.</span><span class="n">PRES</span><span class="p">,</span> <span class="n">natre</span><span class="o">.</span><span class="n">reference_pressure</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">argo_fine_full_profiles</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;argo_profiles_used_for_finestructure.nc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># choose density levels that highlight the depth range we are interested in</span>
<span class="n">rho_levels</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">cole</span><span class="o">.</span><span class="n">density_mean_depth</span><span class="o">.</span><span class="n">interp_like</span><span class="p">(</span><span class="n">colegrad</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">pres</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="all-argo-vs-natre">
<h3>All argo vs NATRE<a class="headerlink" href="#all-argo-vs-natre" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">hexbin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="n">Sbins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="n">Tbins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="n">Pref</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">dcpy</span><span class="o">.</span><span class="n">oceans</span><span class="o">.</span><span class="n">TSplot</span><span class="p">(</span>
    <span class="n">argo_natre</span><span class="o">.</span><span class="n">PSAL</span><span class="p">,</span>
    <span class="n">argo_natre</span><span class="o">.</span><span class="n">THETA</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="n">rho_levels</span><span class="o">=</span><span class="n">rho_levels</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># mask = argo_fine_full_profiles.fine_deepest_bin &gt; 1000</span>

<span class="c1"># _, ax = dcpy.oceans.TSplot(</span>
<span class="c1">#    argo_fine_full_profiles.where(mask, drop=True).PSAL,</span>
<span class="c1">#    argo_fine_full_profiles.where(mask, drop=True).THETA,</span>
<span class="c1">#    **kwargs,</span>
<span class="c1">#    rho_levels=rho_levels,</span>
<span class="c1"># )</span>

<span class="n">dcpy</span><span class="o">.</span><span class="n">oceans</span><span class="o">.</span><span class="n">TSplot</span><span class="p">(</span>
    <span class="n">natre</span><span class="o">.</span><span class="n">salt</span><span class="p">,</span>
    <span class="n">natre</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;argo full&quot;</span><span class="p">,</span> <span class="s2">&quot;natre&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../images/ts-natre.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/natre_45_0.png" src="_images/natre_45_0.png" />
</div>
</div>
</div>
<div class="section" id="finestructure-argo-vs-natre">
<h3>Finestructure Argo vs NATRE<a class="headerlink" href="#finestructure-argo-vs-natre" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">hexbin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="n">Sbins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="n">Tbins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="n">Pref</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The distributions look similar and the argo data capture more extremes; but the NATRE data fill a lot of the space (though smaller S.D.). Maybe the average isn’t that great and it’s totally undersampling</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">argo_fine_full_profiles</span><span class="o">.</span><span class="n">fine_deepest_bin</span> <span class="o">&gt;</span> <span class="mi">1000</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">dcpy</span><span class="o">.</span><span class="n">oceans</span><span class="o">.</span><span class="n">TSplot</span><span class="p">(</span>
    <span class="n">natre</span><span class="o">.</span><span class="n">salt</span><span class="p">,</span>
    <span class="n">natre</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="n">rho_levels</span><span class="o">=</span><span class="n">rho_levels</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">dcpy</span><span class="o">.</span><span class="n">oceans</span><span class="o">.</span><span class="n">TSplot</span><span class="p">(</span>
    <span class="n">argo_fine_full_profiles</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">PSAL</span><span class="p">,</span>
    <span class="n">argo_fine_full_profiles</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">THETA</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;natre&quot;</span><span class="p">,</span> <span class="s2">&quot;argo fine&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../images/ts-natre.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/natre_49_0.png" src="_images/natre_49_0.png" />
</div>
</div>
<p>It’s definitely a big undersampling when compared to all Argo profiles in the area. <strong>How good is good enough?</strong></p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">dcpy</span><span class="o">.</span><span class="n">oceans</span><span class="o">.</span><span class="n">TSplot</span><span class="p">(</span>
    <span class="n">argo_natre</span><span class="o">.</span><span class="n">PSAL</span><span class="p">,</span>
    <span class="n">argo_natre</span><span class="o">.</span><span class="n">THETA</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="n">rho_levels</span><span class="o">=</span><span class="n">rho_levels</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">argo_fine_full_profiles</span><span class="o">.</span><span class="n">fine_deepest_bin</span> <span class="o">&gt;</span> <span class="mi">1000</span>


<span class="n">masked</span> <span class="o">=</span> <span class="n">argo_fine_full_profiles</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">dcpy</span><span class="o">.</span><span class="n">oceans</span><span class="o">.</span><span class="n">TSplot</span><span class="p">(</span>
    <span class="n">masked</span><span class="o">.</span><span class="n">PSAL</span><span class="p">,</span>
    <span class="n">masked</span><span class="o">.</span><span class="n">THETA</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">rho_levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">masked</span><span class="o">.</span><span class="n">groupby</span>
<span class="n">ax</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;argo full&quot;</span><span class="p">,</span> <span class="s2">&quot;argo fine&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;../images/ts-natre-argo.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/natre_51_0.png" src="_images/natre_51_0.png" />
</div>
</div>
</div>
<div class="section" id="conclusions">
<h3>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Can we define a metric using (T-S spread in all argo profiles) vs (TS spread in profiles where we can make a finestructure estimate) to decide where we might be able to make an estimate using Argo?</p></li>
<li><p>Can we refine this?</p>
<ul class="simple">
<li><p>If we expect regions above 1000m then it might not be so bad.</p></li>
<li><p>Could make a bigger box? (skeptical)</p></li>
</ul>
</li>
<li><p>This really points out the limitation of the finestructure estimate, at least deeper down?</p>
<ul class="simple">
<li><p>How does the Whalen scatter plot work out?</p></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="is-there-spatial-uncertainty-cole-estimate-are-we-looking-in-the-wrong-place-no">
<h3>Is there spatial uncertainty? Cole estimate: Are we looking in the wrong place? No<a class="headerlink" href="#is-there-spatial-uncertainty-cole-estimate-are-we-looking-in-the-wrong-place-no" title="Permalink to this headline">¶</a></h3>
<p>Here’s the NATRE region marked on a map of <span class="math notranslate nohighlight">\(K_e\)</span>. There is just low diffusivity everywhere in the box; but may be the mean signal is just northwest of the box</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">cole</span><span class="o">.</span><span class="n">diffusivity</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">pres</span><span class="o">=</span><span class="p">[</span><span class="mi">800</span><span class="p">,</span> <span class="mi">1200</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">350</span><span class="p">),</span> <span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">})</span>
<span class="p">)</span>

<span class="n">fg</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="mi">360</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">31</span><span class="p">,</span> <span class="o">-</span><span class="mi">26</span><span class="p">,</span> <span class="o">-</span><span class="mi">26</span><span class="p">,</span> <span class="o">-</span><span class="mi">31</span><span class="p">,</span> <span class="o">-</span><span class="mi">31</span><span class="p">]),</span> <span class="p">[</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.plot.facetgrid.FacetGrid at 0x7fbb1793f2b0&gt;
</pre></div>
</div>
<img alt="_images/natre_54_1.png" src="_images/natre_54_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="sensitivity-of-pod-estimate-to-mean-k-estimate">
<h2>Sensitivity of χpod estimate to mean K estimate<a class="headerlink" href="#sensitivity-of-pod-estimate-to-mean-k-estimate" title="Permalink to this headline">¶</a></h2>
<p>Various estimates of the variance produced by turbulent stirring of mean vertical gradient</p>
<ol class="simple">
<li><p>Ferrai &amp; Polzin (2005): <span class="math notranslate nohighlight">\(Γ ⟨ε⟩/N_m^2  ∂_zθ_m^2\)</span></p></li>
<li><p>χpod estimate: <span class="math notranslate nohighlight">\(⟨K_T θ_z⟩ ∂_zθ_m\)</span></p></li>
<li><p>(1) with <span class="math notranslate nohighlight">\(ε_χ\)</span> : <span class="math notranslate nohighlight">\(Γ ⟨ε_χ⟩/N_m^2  ∂_zθ_m^2\)</span></p></li>
<li><p>(2) with <span class="math notranslate nohighlight">\(K_ρ\)</span> instead of <span class="math notranslate nohighlight">\(K_T\)</span>: <span class="math notranslate nohighlight">\(⟨K_ρ θ_z⟩  ∂_zθ_m^2\)</span>; <span class="math notranslate nohighlight">\(K_ρ ≪ K_T\)</span>, so this is not good</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">chidens</span><span class="o">.</span><span class="n">Krho_m</span> <span class="o">*</span> <span class="n">chidens</span><span class="o">.</span><span class="n">dTdz_m</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$Γ ⟨ε⟩/N_m^2  ∂_zθ_m^2$&quot;</span>
<span class="p">)</span>

<span class="p">(</span><span class="n">chidens</span><span class="o">.</span><span class="n">KtTz</span> <span class="o">*</span> <span class="n">chidens</span><span class="o">.</span><span class="n">dTdz_m</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$⟨K_T θ_z⟩ ∂_zθ_m$&quot;</span>
<span class="p">)</span>

<span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">chidens</span><span class="o">.</span><span class="n">eps_chi</span> <span class="o">/</span> <span class="n">chidens</span><span class="o">.</span><span class="n">N2_m</span> <span class="o">*</span> <span class="n">chidens</span><span class="o">.</span><span class="n">dTdz_m</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$Γ ⟨ε_χ⟩/N_m^2  ∂_zθ_m^2$&quot;</span>
<span class="p">)</span>

<span class="p">(</span><span class="n">chidens</span><span class="o">.</span><span class="n">KrhoTz</span> <span class="o">*</span> <span class="n">chidens</span><span class="o">.</span><span class="n">dTdz_m</span><span class="p">)</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$⟨K_ρ θ_z⟩  ∂_zθ_m$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Variance production or dissipation [°C²/s]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/natre_57_0.png" src="_images/natre_57_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">micro</span><span class="o">.</span><span class="n">Krho</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">xscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">micro</span><span class="o">.</span><span class="n">Kt</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">micro</span><span class="o">.</span><span class="n">Krho_m</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">micro</span><span class="o">.</span><span class="n">Kt_m</span><span class="o">.</span><span class="n">cf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;$⟨K_ρ⟩$&quot;</span><span class="p">,</span> <span class="s2">&quot;$⟨K_T⟩$&quot;</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;$K_ρ^m = Γ ⟨ε⟩/N_m²$&quot;</span><span class="p">,</span> <span class="s2">&quot;$K_T^m = ⟨χ⟩/2θ_m^2$&quot;</span><span class="p">])</span>
<span class="p">[</span><span class="n">aa</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/natre_58_0.png" src="_images/natre_58_0.png" />
</div>
</div>
</div>
<div class="section" id="bootstrapping-error-bars-on-mean">
<h2>Bootstrapping error bars on mean χ<a class="headerlink" href="#bootstrapping-error-bars-on-mean" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">natre</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">natre</span><span class="o">.</span><span class="n">read_natre</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">choose_bins</span><span class="p">(</span><span class="n">natre</span><span class="o">.</span><span class="n">gamma_n</span><span class="p">,</span> <span class="n">depth_range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">2001</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="n">binned</span> <span class="o">=</span> <span class="n">natre</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()</span><span class="o">.</span><span class="n">groupby_bins</span><span class="p">(</span><span class="s2">&quot;gamma_n&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="compare-neutral-density-bins-to-fp2005">
<h3>Compare neutral density bins to FP2005<a class="headerlink" href="#compare-neutral-density-bins-to-fp2005" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">fp</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
    <span class="p">[</span><span class="mf">26.59</span><span class="p">,</span> <span class="mf">26.95</span><span class="p">,</span> <span class="mf">27.22</span><span class="p">,</span> <span class="mf">27.46</span><span class="p">,</span> <span class="mf">27.64</span><span class="p">,</span> <span class="mf">27.77</span><span class="p">,</span> <span class="mf">27.85</span><span class="p">,</span> <span class="mf">27.91</span><span class="p">,</span> <span class="mf">27.95</span><span class="p">],</span>
    <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,),</span>
    <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">1400</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">1800</span><span class="p">]},</span>
<span class="p">)</span>
<span class="n">fp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FP2005&quot;</span><span class="p">)</span>
<span class="n">micro</span><span class="o">.</span><span class="n">gamma_n</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;pres&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;mine&quot;</span><span class="p">)</span>
<span class="c1">#plt.plot(np.arange(150, 2001, 100), bins, marker=&#39;^&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f2cd6b69f70&gt;
</pre></div>
</div>
<img alt="_images/natre_62_1.png" src="_images/natre_62_1.png" />
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-eddydiff-py"
        },
        kernelOptions: {
            kernelName: "conda-env-eddydiff-py",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-eddydiff-py'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="bootstrap-ctd-chipod-estimates.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Bootstrapped outlier detection for CTD-χpod</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="natre-examine.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">NATRE microstructure dataset</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Deepak Cherian<br/>
    
        &copy; Copyright 2021.<br/>
      <div class="extra_footer">
        <div>
<script data-goatcounter="https://count.cherian.net/count"
        async src="count.js"></script>
</div>

      </div>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>